#!/usr/bin/env bash

PROVINCES_FOR='["USA", "JPN", "GBR", "CHN"]'
MIN_AREA=10000000000

command -v npm >/dev/null 2>&1 || {
    echo >&2 "Please install Node.js v6.x!";
    exit 1;
}

command -v mapshaper >/dev/null 2>&1 || {
    echo >&2 "Installing mapshaper!";
    npm i -g mapshaper;
}

mapshaper \
    -i ./country-info.json ./ne_10m_admin_1_states_provinces/ne_10m_admin_1_states_provinces.shp snap combine-files \
    -rename-layers data,raw \
    -rename-fields target=raw country_code=adm0_a3,country=admin,state=name,state_code=postal \
    \
    -simplify weighted 3% \
    -each target=raw 'country="French Guiana"; country_code="GUF"' where='country_code==="FRA" && state_code==="CY"' \
    -filter target=raw 'country_code!=="ATA"' \
    -filter target=raw 'type_en!=="Overseas department"' \
    -filter-fields target=raw country,country_code,state,state_code \
    \
    -filter target=raw "$PROVINCES_FOR.indexOf(this.properties.country_code) !== -1" no-replace name=states \
    -dissolve country_code target=raw no-replace copy-fields=country name=countries \
    \
    -filter-slivers target=countries min-area=1 remove-empty \
    -filter target=countries "this.area > $MIN_AREA" \
    \
    -join data target=countries keys=country_code,alpha-3 fields=region,region-code,sub-region,sub-region-code \
    -rename-fields target=countries region_id=region-code,sub_region=sub-region,sub_region_id=sub-region-code \
    \
    -dissolve sub_region_id target=countries copy-fields=region,region_id,sub_region,sub_region_id no-replace name=sub_regions \
    \
    -filter target=sub_regions 'sub_region === "Northern America"' no-replace name=north-america \
    -filter target=sub_regions 'sub_region === "Caribbean" || sub_region === "Central America"' no-replace name=central-america \
    -filter target=sub_regions 'sub_region === "South America"' no-replace name=south-america \
    \
    -filter-fields target=north-america,central-america,south-america sub_region,sub_region_id \
    -rename-fields target=north-america,central-america,south-america region=sub_region,region_id=sub_region_id \
    \
    -each target=central-america 'region="Central America"; region_id="013"' \
    -dissolve region_id target=central-america copy-fields=region,region_id \
    -each target=north-america 'region="North America"' \
    \
    -filter target=sub_regions 'region !== "Americas"' no-replace name=continents \
    -dissolve region_id target=continents copy-fields=region,region_id \
    \
    -merge-layers target=continents,north-america,central-america,south-america name=regions \
    \
    -o ./map.json format=topojson target=regions,countries,states bbox prettify force
